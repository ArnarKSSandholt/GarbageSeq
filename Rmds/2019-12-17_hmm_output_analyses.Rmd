---
title: "HMM search output analyses with max e-val:s"
author: "LJM"
date: "`r Sys.Date()`"
link-citations: true
bibliography: bibliography.bib
biblio-style: "alpha" #https://www.overleaf.com/learn/latex/Bibtex_bibliography_styles
#csl: "../uppsala-universitet-institutionen-for-biologisk-grundutbildning.csl"
documentclass: report
output:
  bookdown::html_document2:
    highlight: tango
    theme: journal
    split_by: none # only generate a single output page
    self_contained: TRUE
    toc: yes
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
      print: FALSE
    code_folding: show
    number_sections: TRUE
    code_download: TRUE
  html_document: 
    toc: TRUE
    toc_float: TRUE
    code_folding: show
    highlight: tango
    number_sections: TRUE
    self_contained: TRUE
    smart: TRUE # To be figured out when this is useful
    theme: journal
  pdf_document:
    toc: TRUE
    toc_depth: 2
    highlight: tango # This appears to be the same as default
    number_sections: TRUE
  bookdown::html_document2:
    highlight: tango
    theme: journal
    split_by: none # only generate a single output page
    self_contained: TRUE
    toc: yes
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
      print: FALSE
    code_folding: show
    number_sections: TRUE
    code_download: TRUE
---

This document contains the final analyses and visualialisations of HMMer search with eggNOG viral HMM profiles on fOTUs.


# Load libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
#library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
#install.packages("vegan")
library(vegan)
library(rentrez)
library(XML)
```

# Read intermediary `csv` file

In the intermediary `csv` file the $-log_{10}(\text{e-val})$:s are the maximum e-values among all the hits to the fOTUs instead (and in contrast to the previous run in file `2019-11-25_hmmsearch_output_analyses.Rmd`) of the average of all the HMMsearch hits to the fOTUs.


```{r eval=FALSE, include=TRUE}
columns <- paste("c", strrep("d",8315), sep = "")
fOTUsHMM <- read_csv(file = "../analyses/HMMsearch/max_fOTUsHMM.csv", col_types = columns)
```

# Exchange NA, Inf and -Inf with 0

```{r eval=FALSE, include=TRUE}
is.na(fOTUsHMM) <- sapply(fOTUsHMM, is.infinite)
fOTUsHMM[is.na(fOTUsHMM)] <- 0
```

# Move fOTU names to row names and execute PCA 

```{r eval=FALSE, include=TRUE}
fOTUsHMM_pca <- fOTUsHMM %>% 
  column_to_rownames(var = "fOTU_name") %>%
  prcomp(., 
         center = TRUE)
```

# Visualise the results

## PCA plots {#pca-preview}

These PCA plots can be used to visually determine potential groupings.

```{r}
file_name <- "../visualisations/HMMsearch/ggbiplot_max_PC1-2.png"
png(filename = file_name)
ggbiplot(fOTUsHMM_pca, var.axes = F, choices = 1:2)
dev.off()
ggbiplot(fOTUsHMM_pca, var.axes = F, choices = 1:2)
```

Here above the plot is slightly squashed but the following aren't:

```{r eval=FALSE, include=TRUE}

PC12s <- tibble(fOTUs = names(fOTUsHMM_pca$x[,1]), 
              PC1 = unname(fOTUsHMM_pca$x[,1]), 
              PC2 = unname(fOTUsHMM_pca$x[,2]))

title <- "PCA of e-values of matches in fOTUs"
qplot(PC1, 
      PC2, 
      data = PC12s, 
      geom = c("point", "density2d")) + ggtitle(title)

ggsave(filename = "../visualisations/HMMsearch/pca_hmmsearch_max_PC1-2.png",
       device = png, 
       width = 1000, 
       height = 750, 
       units = "in",
       limitsize = FALSE,
       dpi = 320)

PC23s <- tibble(fOTUs = names(fOTUsHMM_pca$x[,1]), 
              PC2 = unname(fOTUsHMM_pca$x[,2]), 
              PC3 = unname(fOTUsHMM_pca$x[,3]))

title <- "PCA of e-values of matches in fOTUs"
qplot(PC2, 
      PC3, 
      data = PC23s, 
      geom = c("point", "density2d")) + ggtitle(title)

ggsave(filename = "../visualisations/HMMsearch/pca_hmmsearch_max_PC2-3.png",
       device = png, 
       width = 1000, 
       height = 750, 
       units = "in",
       limitsize = FALSE,
       dpi = 320)

PC34s <- tibble(fOTUs = names(fOTUsHMM_pca$x[,1]), 
              PC3 = unname(fOTUsHMM_pca$x[,3]), 
              PC4 = unname(fOTUsHMM_pca$x[,4]))

title <- "PCA of e-values of matches in fOTUs"
qplot(PC3, 
      PC4, 
      data = PC34s, 
      geom = c("point", "density2d")) + ggtitle(title)

ggsave(filename = "../visualisations/HMMsearch/pca_hmmsearch_max_PC3-4.png",
       device = png, 
       width = 1000, 
       height = 750, 
       units = "in",
       limitsize = FALSE,
       dpi = 320)
```

## Heatmaps

```{r eval=FALSE, include=TRUE}
dim(fOTUsHMM_pca)
prediction <- predict(fOTUsHMM_pca)[,1:20]
file_name <- "../visualisations/HMMsearch/heatmap_max_20_first_PCs.png"
png(filename = file_name)
heatmap(as.matrix(prediction))
dev.off()
heatmap(as.matrix(prediction))

file_name <- "../visualisations/HMMsearch/heatmap_max_400_first_fOTUs.png"
png(filename = file_name)
heatmap(as.matrix(fOTUsHMM[,-1])[,1:400])
dev.off()
heatmap(as.matrix(fOTUsHMM[,-1])[,1:400])
```

# NMDS

Let's perform non-metric multidimensional scaling:

```{r eval=FALSE, include=TRUE}
width <- dim(fOTUsHMM)[2]
ord <- metaMDS(fOTUsHMM[,2:width])
```

# Save/Load R data

Save the data once again to speed-up things.

```{r eval=FALSE, include=TRUE}
#saveRDS(ord, file = "../analyses/HMMsearch/R_data/max_ord.rds")
ord <- readRDS(file = "../analyses/HMMsearch/R_data/max_ord.rds")
```

How well does the 2-D representation of multidimensional space represent the actual multidimensional space is done by using statistic called stress. Stress < 0.1 indicates that the 2-D representation is a good repreresentation of the multi-D space. Let's check that out now:

```{r eval=FALSE, include=TRUE}
ord$stress
```

This is quite low which is great! Let's now plot out the relationship between the ordination dissimilarities and the distances in the ordination space:

```{r eval=FALSE, include=TRUE}
stressplot(ord)
```

Observed dissimilarity of 1 means the fOTU doesn't have any HMMs incommon with the others.

Let's plot out the ordination space in 2-d:

```{r eval=FALSE, include=TRUE}
ordiplot(ord)
points(ord)
```

# Remove outliers

```{r eval=FALSE, include=TRUE}
NMDS_points <- as_tibble(ord$points) %>%
  filter(MDS1 > -2)
```

# Visualise the filtered data

```{r eval=FALSE, include=TRUE}
title <- "Non-metric multidimensional scaling data"
qplot(MDS1, 
      MDS2, 
      data = NMDS_points, 
      geom = c("point", "density2d")) + ggtitle(title)

path <- "../visualisations/HMMsearch/nmds_hmmsearch_max_MDS1_greater_than_-2.png"

ggsave(filename = path,
       device = png, 
       width = 1000, 
       height = 750, 
       units = "in",
       limitsize = FALSE,
       dpi = 320)
```

# Create lists of fOTUs of interest

Based on the previewing of PCA plots in \@ref(pca-preview) we can now manually curate a lists of fOTUs approximately based on clustering in them. 

Let's first create file names:

```{r eval=FALSE, include=TRUE}
# Path to files
path <- "../analyses/HMMsearch/lists_of_PCA_clusters/"

# Names of files
PC12a_filename <- paste(path,
                        "fOTU_max_PC1-and-2_x--100-to-0-and-y--50-to-+50.txt", 
                        sep = "", 
                        collapse = NULL)
PC12b_filename <- paste(path,
                        "fOTU_max_PC1-and-2_x-+200-to-+500-and-y--100-to-0.txt", 
                        sep = "", 
                        collapse = NULL)


PC23a_filename <- paste(path,
                       "fOTU_max_PC2-and-3_x--100-to-+75-and-y--150-to-+80.txt", 
                       sep = "", 
                       collapse = NULL)
PC23b_filename <- paste(path,
                       "fOTU_max_PC2-and-3_x-+100-to-+250-and-y--80-to-+125.txt", 
                       sep = "", 
                       collapse = NULL)
PC23c_filename <- paste(path,
                       "fOTU_max_PC2-and-3_x-+250-to-+425-and-y--200-to-0.txt", 
                       sep = "", 
                       collapse = NULL)
PC23d_filename <- paste(path,
                       "fOTU_max_PC2-and-3_x-+400-to-+650-and-y--210-to--80.txt", 
                       sep = "", 
                       collapse = NULL)
PC23e_filename <- paste(path,
                       "fOTU_max_PC2-and-3_x-0-to-+200-and-y-+200-to-+450.txt", 
                       sep = "", 
                       collapse = NULL)


PC34a_filename <- paste(path,
                       "fOTU_max_PC3-and-4_x--80-to-+80-and-y--50-to-+75.txt", 
                       sep = "", 
                       collapse = NULL)
PC34b_filename <- paste(path,
                       "fOTU_max_PC3-and-4_x--50-to-0-and-y-+75-to-+175.txt", 
                       sep = "", 
                       collapse = NULL)
PC34c_filename <- paste(path,
                       "fOTU_max_PC3-and-4_x-+200-to-+450-and-y--25-to-+50.txt", 
                       sep = "", 
                       collapse = NULL)
```

and then we'll filter tibbles based on their coordinates with a simple function:

```{r eval=FALSE, include=TRUE}
# This function filters a tibble based on given limit values
filterator <- function(data, 
                       x_low = -9999, 
                       x_high = 9999, 
                       y_low = -9999, 
                       y_high = 9999){
  data %>% 
    filter(data[,2] > x_low & data[,2] < x_high & data[,3] > y_low & data[,3] < y_high) %>%
    select(fOTUs)
}
```

and the actual filtering:

```{r eval=FALSE, include=TRUE}
PC12_cluster1 <- filterator(PC12s,-100,0,-50,50) 
PC12_cluster2 <- filterator(PC12s,200,500,-100,0)

PC23_cluster1 <- filterator(PC23s,-100,75,-150,80)
PC23_cluster2 <- filterator(PC23s,100,250,-80,125)
PC23_cluster3 <- filterator(PC23s,250,425,-200,0)
PC23_cluster4 <- filterator(PC23s,400,650,-210,80)
PC23_cluster5 <- filterator(PC23s,0,200,200,450)

PC34_cluster1 <- filterator(PC34s,-80,80,-50,75)
PC34_cluster2 <- filterator(PC34s,-50,0,75,175)
PC34_cluster3 <- filterator(PC34s,200,450,-25,50)
```

Lastly, we'll just write the files:

```{r eval=FALSE, include=TRUE}
write_delim(PC12_cluster1, 
            PC12a_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC12_cluster2, 
            PC12b_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")

write_delim(PC23_cluster1, 
            PC23a_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC23_cluster2, 
            PC23b_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC23_cluster3, 
            PC23c_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC23_cluster4, 
            PC23d_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC23_cluster5, 
            PC23e_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")

write_delim(PC34_cluster1, 
            PC34a_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC34_cluster2, 
            PC34b_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
write_delim(PC34_cluster3, 
            PC34c_filename, 
            delim = "", 
            na = "NA", 
            append = FALSE,
            col_names = FALSE, 
            quote_escape = "double")
```






# Session info

```{r}
sessionInfo()
```


# References