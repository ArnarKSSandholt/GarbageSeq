---
title: "Searching further on viral matching HMM profiles"
author: "LJM"
date: "`r Sys.Date()`"
link-citations: true
bibliography: bibliography.bib
biblio-style: "alpha" #https://www.overleaf.com/learn/latex/Bibtex_bibliography_styles
#csl: "../uppsala-universitet-institutionen-for-biologisk-grundutbildning.csl"
subtitle: "Studying further what matched the fOTUs for purposes of trying to validate the results"
subject: "Study further what matched the fOTUs for purposes of trying to validate the results."
keywords: 
  - bioinformatics
  - HMMer
  - eggNOG 
output:
  bookdown::html_document2:
    highlight: tango
    theme: yeti
    split_by: none # only generate a single output page
    self_contained: TRUE
    toc: yes
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
      print: FALSE
    code_folding: show
    number_sections: TRUE
    code_download: TRUE
    pandoc_args: ["--top-level-division=section",
              "-V", "documentclass=report"]
              
  bookdown::pdf_document2:
    keep_tex: no
    latex_engine: xelatex
    #highlight: pygments #Other options: default, tango, kate, monochrome, espresso, zenburn, haddock, and textmate
    #theme: spacelab
    # https://pandoc.org/MANUAL.html
    pandoc_args: ["--top-level-division=section",
                  "-V", "documentclass=article",
                  "-V", "linkcolor=MidnightBlue",
                  "-V", "citecolor=Aquamarine",
                  "-V", "urlcolor=NavyBlue",
                  "-V", "toccolor=black",
                  "-V", "pagestyle=headings"]
---

\clearpage

# Introduction

It would be nice to know further what viruses contributed to HMMs that matched to the fOTUs. Fortunately EggNOG database v 5.0 [@Huerta-Cepas2019] provides that information. Let's download the relevant file from EggNOG database and taxonomic data from NCBI and create one big tsv file with all that information. Thereafter, let's check which HMMs matched significantly (with $-log_{10}\text{(e-value)}$ of 2 or higher) to which fOTUs. 

## Load libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

\clearpage

# Download from eggNOG database

## Download members information on all viral HMMs

```{bash eval=FALSE, include=TRUE}
OUTPUT="../analyses/HMMsearch/validation_and_further_analyses/10239_members.tsv.gz"
wget --verbose --continue --output-document="$OUTPUT" \
"http://eggnog5.embl.de/download/eggnog_5.0/per_tax_level/10239/10239_members.tsv.gz"
gunzip "$OUTPUT"
```

## Download annotation information on all viral HMMs

```{bash eval=FALSE, include=TRUE}
OUTPUT="../analyses/HMMsearch/validation_and_further_analyses/10239_annotations.tsv.gz"
wget --verbose --continue --output-document="$OUTPUT" \
"http://eggnog5.embl.de/download/eggnog_5.0/per_tax_level/10239/10239_annotations.tsv.gz"
gunzip "$OUTPUT"
```

\clearpage

# Merge annotations and members files

```{bash eval=FALSE, include=TRUE}
INPUT1="../analyses/HMMsearch/validation_and_further_analyses/10239_annotations.tsv"
INPUT2="../analyses/HMMsearch/validation_and_further_analyses/10239_members.tsv"
SCRIPT="../scripts/merge_files.awk"
OUT="../analyses/HMMsearch/validation_and_further_analyses/10239_members_annotations.tsv"

awk -f $SCRIPT $INPUT1 $INPUT2 > $OUT
```

Now let's take a short look at the output

```{bash}
IN="../analyses/HMMsearch/validation_and_further_analyses/10239_members_annotations.tsv"
head -n 3 $IN
```

Looks pretty ok.

Now we need to fetch taxonomic information from NCBI based on mem_taxid column information and append it to this previous data. R package `rentrez` can handle the accessing of NCBI and tidyverse can handle the rest.

\clearpage

# Fetch information from NCBI on each HMM

Let's use Biopython v. 1.75 [@Cock2009] to access NCBI's taxonomy database for retrieving interesting taxonomic information about the viruses which contributed their proteins in the HMMs used. Biopython comes also with a handy parser of the XML format data that is returned from NCBI on each request.

```{bash}
IN="../analyses/HMMsearch/validation_and_further_analyses/10239_members_annotations.tsv"
SCRIPT="../scripts/fetch_taxon_data.py"
AWK_PARSER="../scripts/deWhiteSpacer.awk"
OUTPUT="../analyses/HMMsearch/validation_and_further_analyses/lineages.tsv"
# Retain fields of interest with AWK, process with python by augmenting the data with
# taxon info from NCBI and print out in a nicely machine readable format with AWK
awk -F"\t" 'BEGIN{OFS=","}{print $2,$5}' $IN | python3 $SCRIPT | awk -F"@" -f $AWK_PARSER > $OUTPUT
```



\clearpage

# Session info

```{r}
sessionInfo()
```

\clearpage

# References